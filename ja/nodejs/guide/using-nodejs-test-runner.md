---
title: Node.js ã®ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹
description: Node.js ã®çµ„ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’è¨­å®šãŠã‚ˆã³ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®ã‚¬ã‚¤ãƒ‰ã€ä¸€èˆ¬è¨­å®šã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ†ã‚¹ãƒˆã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒ†ã‚¹ãƒˆãªã©ã‚’å«ã‚€ã€‚
head:
  - - meta
    - name: og:title
      content: Node.js ã®ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ | Node.js - iDoc.dev
  - - meta
    - name: og:description
      content: Node.js ã®çµ„ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’è¨­å®šãŠã‚ˆã³ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®ã‚¬ã‚¤ãƒ‰ã€ä¸€èˆ¬è¨­å®šã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ†ã‚¹ãƒˆã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒ†ã‚¹ãƒˆãªã©ã‚’å«ã‚€ã€‚
  - - meta
    - name: twitter:title
      content: Node.js ã®ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ | Node.js - iDoc.dev
  - - meta
    - name: twitter:description
      content: Node.js ã®çµ„ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’è¨­å®šãŠã‚ˆã³ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®ã‚¬ã‚¤ãƒ‰ã€ä¸€èˆ¬è¨­å®šã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ†ã‚¹ãƒˆã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒ†ã‚¹ãƒˆãªã©ã‚’å«ã‚€ã€‚
---


# Node.js ã®ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã®ä½¿ç”¨

Node.js ã«ã¯ã€æŸ”è»Ÿã§å …ç‰¢ãªçµ„ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€ãã®è¨­å®šæ–¹æ³•ã¨ä½¿ç”¨æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

::: code-group
```bash [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦]
example/
  â”œ â€¦
  â”œ src/
    â”œ app/â€¦
    â”” sw/â€¦
  â”” test/
    â”œ globals/
      â”œ â€¦
      â”œ IndexedDb.js
      â”” ServiceWorkerGlobalScope.js
    â”œ setup.mjs
    â”œ setup.units.mjs
    â”” setup.ui.mjs
```
```bash [ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«]
npm init -y
npm install --save-dev concurrently
```
```json [package.json]
{
  "name": "example",
  "scripts": {
    "test": "concurrently --kill-others-on-fail --prefix none npm:test:*",
    "test:sw": "node --import ./test/setup.sw.mjs --test './src/sw/**/*.spec.*'",
    "test:units": "node --import ./test/setup.units.mjs --test './src/app/**/*.spec.*'",
    "test:ui": "node --import ./test/setup.ui.mjs --test './src/app/**/*.test.*'"
  }
}
```
:::

::: info NOTE
ã‚°ãƒ­ãƒ–ã«ã¯ node v21 ä»¥é™ãŒå¿…è¦ã§ã™ã€‚ã¾ãŸã€ã‚°ãƒ­ãƒ–è‡ªä½“ã‚’å¼•ç”¨ç¬¦ã§å›²ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå›²ã¾ãªã„ã¨ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã¨ã¯ç•°ãªã‚‹å‹•ä½œã«ãªã‚Šã¾ã™ã€‚æœ€åˆã¯å‹•ä½œã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€å®Ÿéš›ã«ã¯å‹•ä½œã—ã¦ã„ã¾ã›ã‚“ï¼‰ã€‚
:::

å¸¸ã«å¿…è¦ãªã‚‚ã®ãŒã„ãã¤ã‹ã‚ã‚‹ã®ã§ã€æ¬¡ã®ã‚ˆã†ãªåŸºæœ¬è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ãã‚Œã‚‰ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ä»–ã®ã€ã‚ˆã‚Šã‚ªãƒ¼ãƒ€ãƒ¼ãƒ¡ã‚¤ãƒ‰ã®è¨­å®šã«ã‚ˆã£ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚

## ä¸€èˆ¬çš„ãªè¨­å®š

```js
import { register } from 'node:module';
register('some-typescript-loader');
// TypeScript ã¯ä»¥é™ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã™
// ãŸã ã—ã€ä»–ã® test/setup.*.mjs ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ãª JavaScript ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼
```

æ¬¡ã«ã€å„è¨­å®šã«å¯¾ã—ã¦ã€å°‚ç”¨ã® `setup` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ï¼ˆå„ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ãƒ™ãƒ¼ã‚¹ `setup.mjs` ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚è¨­å®šã‚’åˆ†é›¢ã™ã‚‹ç†ç”±ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ãŒã€æœ€ã‚‚æ˜ç™½ãªç†ç”±ã¯[YAGNI](https://ja.wikipedia.org/wiki/YAGNI) + ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã§ã™ã€‚è¨­å®šã™ã‚‹ã‚‚ã®ã®å¤šãã¯ç’°å¢ƒå›ºæœ‰ã®ãƒ¢ãƒƒã‚¯/ã‚¹ã‚¿ãƒ–ã§ã‚ã‚Šã€éå¸¸ã«ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚Šã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚’é…ãã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å¿…è¦ãªã„å ´åˆã¯ã€ã“ã‚Œã‚‰ã®ã‚³ã‚¹ãƒˆï¼ˆCI ã«æ”¯æ‰•ã†æ–‡å­—é€šã‚Šã®ãŠé‡‘ã€ãƒ†ã‚¹ãƒˆã®å®Œäº†ã‚’å¾…ã¤æ™‚é–“ãªã©ï¼‰ã‚’å›é¿ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®å„ä¾‹ã¯ã€å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å–å¾—ã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é©åˆ‡/é©ç”¨å¯èƒ½ã§ã¯ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ãã‚Œãã‚ŒãŒåºƒãé©ç”¨å¯èƒ½ãªä¸€èˆ¬çš„ãªæ¦‚å¿µã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚


## ServiceWorker ãƒ†ã‚¹ãƒˆ

`ServiceWorkerGlobalScope` ã¯ã€ä»–ã®ç’°å¢ƒã«ã¯å­˜åœ¨ã—ãªã„éå¸¸ã«ç‰¹æ®Šãª API ã‚’å«ã‚“ã§ãŠã‚Šã€ãã® API ã®ä¸€éƒ¨ã¯ä»–ã® API (ä¾‹: `fetch`) ã¨ä¸€è¦‹ä¼¼ã¦ã„ã¾ã™ãŒã€æ‹¡å¼µã•ã‚ŒãŸå‹•ä½œã‚’ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã® API ãŒç„¡é–¢ä¿‚ãªãƒ†ã‚¹ãƒˆã«æ¼ã‚Œå‡ºã‚‹ã“ã¨ã¯é¿ã‘ãŸã„ã§ã—ã‚‡ã†ã€‚

```js
import { beforeEach } from 'node:test';

import { ServiceWorkerGlobalScope } from './globals/ServiceWorkerGlobalScope.js';

import './setup.mjs'; // ğŸ’¡

beforeEach(globalSWBeforeEach);
function globalSWBeforeEach() {
  globalThis.self = new ServiceWorkerGlobalScope();
}
```
```js
import assert from 'node:assert/strict';
import { describe, mock, it } from 'node:test';

import { onActivate } from './onActivate.js';

describe('ServiceWorker::onActivate()', () => {
  const globalSelf = globalThis.self;
  const claim = mock.fn(async function mock__claim() {});
  const matchAll = mock.fn(async function mock__matchAll() {});

  class ActivateEvent extends Event {
    constructor(...args) {
      super('activate', ...args);
    }
  }

  before(() => {
    globalThis.self = {
      clients: { claim, matchAll },
    };
  });
  after(() => {
    global.self = globalSelf;
  });

  it('should claim all clients', async () => {
    await onActivate(new ActivateEvent());

    assert.equal(claim.mock.callCount(), 1);
    assert.equal(matchAll.mock.callCount(), 1);
  });
});
```

## ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

ã“ã‚Œã‚‰ã¯ Jest ã«ã‚ˆã£ã¦æ™®åŠã—ã¾ã—ãŸã€‚ç¾åœ¨ã€å¤šãã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€Node.js ã‚‚ v22.3.0 ä»¥é™åŒæ§˜ã§ã™ã€‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡ºåŠ›ã®æ¤œè¨¼ã‚„ã€[Infrastructure as Code](https://en.wikipedia.org/wiki/Infrastructure_as_code) ã®è¨­å®šãªã©ã€ã„ãã¤ã‹ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚æ¦‚å¿µã¯ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«é–¢ä¿‚ãªãåŒã˜ã§ã™ã€‚

`--experimental-test-snapshots` ã‚’ä»‹ã—ã¦æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã‚’é™¤ã„ã¦ã€ç‰¹å®šã®æ§‹æˆã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ§‹æˆã‚’ç¤ºã™ã«ã¯ã€æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã„ãšã‚Œã‹ã«æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã‚’è¿½åŠ ã™ã‚‹ã§ã—ã‚‡ã†ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€node ã¯æ§‹æ–‡ãƒã‚¤ãƒ©ã‚¤ãƒˆã®æ¤œå‡ºã¨äº’æ›æ€§ã®ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å `.js.snapshot` ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯å®Ÿéš›ã«ã¯ CJS ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ãŸã‚ã€ã‚ˆã‚Šé©åˆ‡ãªãƒ•ã‚¡ã‚¤ãƒ«åã¯ `.snapshot.cjs` (ã¾ãŸã¯ã‚ˆã‚Šç°¡æ½”ã«ä¸‹ã®ä¾‹ã®ã‚ˆã†ã« `.snap.cjs`) ã§çµ‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ESM ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚ã‚ˆã‚Šé©åˆ‡ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚

```js
import { basename, dirname, extname, join } from 'node:path';
import { snapshot } from 'node:test';

snapshot.setResolveSnapshotPath(generateSnapshotPath);
/**
 * @param {string} testFilePath '/tmp/foo.test.js'
 * @returns {string} '/tmp/foo.test.snap.cjs'
 */
function generateSnapshotPath(testFilePath) {
  const ext = extname(testFilePath);
  const filename = basename(testFilePath, ext);
  const base = dirname(testFilePath);

  return join(base, `${filename}.snap.cjs`);
}
```

ä»¥ä¸‹ã®ä¾‹ã¯ã€UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® [testing library](https://testing-library.com/) ã‚’ä½¿ç”¨ã—ãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’ç¤ºã—ã¦ã„ã¾ã™ ( `assert.snapshot` ã¸ã® 2 ã¤ã®ç•°ãªã‚‹ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã«æ³¨æ„ã—ã¦ãã ã•ã„)ã€‚

```js
import { describe, it } from 'node:test';

import { prettyDOM } from '@testing-library/dom';
import { render } from '@testing-library/react'; // Any framework (ex svelte)

import { SomeComponent } from './SomeComponent.jsx';


describe('<SomeComponent>', () => {
  // For people preferring "fat-arrow" syntax, the following is probably better for consistency
  it('should render defaults when no props are provided', (t) => {
    const component = render(<SomeComponent />).container.firstChild;

    t.assert.snapshot(prettyDOM(component));
  });

  it('should consume `foo` when provided', function() {
    const component = render(<SomeComponent foo="bar" />).container.firstChild;

    this.assert.snapshot(prettyDOM(component));
    // `this` works only when `function` is used (not "fat arrow").
  });
});
```

::: warning
`assert.snapshot` ã¯ `node:assert` ã§ã¯ãªãã€ãƒ†ã‚¹ãƒˆã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ (t ã¾ãŸã¯ this) ã‹ã‚‰å–å¾—ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒ `node:assert` ã§ã¯ä¸å¯èƒ½ãªã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãŸã‚ã«å¿…è¦ã§ã™ ( `snapshot (this, value)` ã®ã‚ˆã†ã« `assert.snapshot` ãŒä½¿ç”¨ã•ã‚Œã‚‹ãŸã³ã«æ‰‹å‹•ã§æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã‹ãªã‚Šé¢å€’ã§ã™)ã€‚
:::


## ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¯æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚¹ãƒˆã§ã‚ã‚Šã€é€šå¸¸ã¯ç‰¹åˆ¥ãªã‚‚ã®ã‚’å¿…è¦ã¨ã—ã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆã®å¤§éƒ¨åˆ†ã¯ãŠãã‚‰ããƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã«ãªã‚‹ã§ã—ã‚‡ã†ã‹ã‚‰ã€ã“ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ãªãœãªã‚‰ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒã‚ãšã‹ã«ä½ä¸‹ã™ã‚‹ã ã‘ã§ã‚‚ã€ãã‚ŒãŒæ‹¡å¤§ã—ã¦é€£é–ã™ã‚‹ã‹ã‚‰ã§ã™ã€‚

```js
import { register } from 'node:module';

import './setup.mjs'; // ğŸ’¡

register('some-plaintext-loader');
// plain-text files like graphql can now be imported:
// import GET_ME from 'get-me.gql'; GET_ME = '
```

```js
import assert from 'node:assert/strict';
import { describe, it } from 'node:test';

import { Cat } from './Cat.js';
import { Fish } from './Fish.js';
import { Plastic } from './Plastic.js';

describe('Cat', () => {
  it('should eat fish', () => {
    const cat = new Cat();
    const fish = new Fish();

    assert.doesNotThrow(() => cat.eat(fish));
  });

  it('should NOT eat plastic', () => {
    const cat = new Cat();
    const plastic = new Plastic();

    assert.throws(() => cat.eat(plastic));
  });
});
```

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒ†ã‚¹ãƒˆ

UIãƒ†ã‚¹ãƒˆã¯ä¸€èˆ¬çš„ã«DOMã‚’å¿…è¦ã¨ã—ã€å ´åˆã«ã‚ˆã£ã¦ã¯ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶å›ºæœ‰ã®APIï¼ˆä¸‹è¨˜ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹`IndexedDb`ãªã©ï¼‰ã‚‚å¿…è¦ã¨ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯éå¸¸ã«è¤‡é›‘ã§ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚

`IndexedDb`ã®ã‚ˆã†ãªAPIã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŒã€ãã‚ŒãŒéå¸¸ã«éš”é›¢ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒƒã‚¯ã¯é©åˆ‡ãªæ–¹æ³•ã§ã¯ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ã€ã“ã®`beforeEach`ã‚’`IndexedDb`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã«ç§»å‹•ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`IndexedDb`ï¼ˆã¾ãŸã¯ãã®ä»–ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªä½“ãŒåºƒãã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ã‹ï¼ˆãŠãã‚‰ãã‚ˆã‚Šè‰¯ã„é¸æŠè‚¢ï¼‰ã€ã“ã“ã«ä¿æŒã—ã¦ãã ã•ã„ã€‚

```js
import { register } from 'node:module';

// âš ï¸ JSDomã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯1ã¤ã ã‘ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚è¤‡æ•°ç”Ÿæˆã™ã‚‹ã¨å¤šãã®ğŸ¤¬ã«ã¤ãªãŒã‚Šã¾ã™ã€‚
import jsdom from 'global-jsdom';

import './setup.units.mjs'; // ğŸ’¡

import { IndexedDb } from './globals/IndexedDb.js';

register('some-css-modules-loader');

jsdom(undefined, {
  url: 'https://test.example.com', // âš ï¸ ã“ã‚Œã‚’æŒ‡å®šã—ãªã„ã¨ã€å¤šãã®ğŸ¤¬ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
});

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚’è£…é£¾ã™ã‚‹æ–¹æ³•ã®ä¾‹ã€‚
// JSDOMã®`history`ã¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†ã—ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã¯ã»ã¨ã‚“ã©ã®å ´åˆã‚’å‡¦ç†ã—ã¾ã™ã€‚
const pushState = globalThis.history.pushState.bind(globalThis.history);
globalThis.history.pushState = function mock_pushState(data, unused, url) {
  pushState(data, unused, url);
  globalThis.location.assign(url);
};

beforeEach(globalUIBeforeEach);
function globalUIBeforeEach() {
  globalThis.indexedDb = new IndexedDb();
}
```

UIãƒ†ã‚¹ãƒˆã«ã¯2ã¤ã®ç•°ãªã‚‹ãƒ¬ãƒ™ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚ãƒ¦ãƒ‹ãƒƒãƒˆãƒ©ã‚¤ã‚¯ãªã‚‚ã®ï¼ˆå¤–éƒ¨ãŠã‚ˆã³ä¾å­˜é–¢ä¿‚ãŒãƒ¢ãƒƒã‚¯ã•ã‚Œã‚‹ï¼‰ã¨ã€ã‚ˆã‚Šã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãªã‚‚ã®ï¼ˆIndexedDbã®ã‚ˆã†ãªå¤–éƒ¨ã®ã¿ãŒãƒ¢ãƒƒã‚¯ã•ã‚Œã€æ®‹ã‚Šã®ãƒã‚§ãƒ¼ãƒ³ã¯æœ¬ç‰©ï¼‰ã€‚å‰è€…ã¯ä¸€èˆ¬çš„ã«ç´”ç²‹ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€å¾Œè€…ã¯é€šå¸¸ã€[Playwright](https://playwright.dev/)ã‚„[Puppeteer](https://pptr.dev/)ã®ã‚ˆã†ãªã‚‚ã®ã§å®Œå…¨ã«ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã«å§”ã­ã‚‰ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã¯å‰è€…ã®ä¾‹ã§ã™ã€‚

```js
import { before, describe, mock, it } from 'node:test';

import { screen } from '@testing-library/dom';
import { render } from '@testing-library/react'; // Any framework (ex svelte)

// âš ï¸ SomeOtherComponentã¯é™çš„ãªã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ã¯ãªã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
// ã“ã‚Œã¯ã€ç‹¬è‡ªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ãƒ¢ãƒƒã‚¯ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã«å¿…è¦ãªã“ã¨ã§ã™ã€‚


describe('<SomeOtherComponent>', () => {
  let SomeOtherComponent;
  let calcSomeValue;

  before(async () => {
    // âš ï¸ é †åºãŒé‡è¦ã§ã™ã€‚ãƒ¢ãƒƒã‚¯ã¯ãã®ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒãƒ¼ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã‚‹å‰ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

    // `--experimental-test-module-mocks`ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    calcSomeValue = mock.module('./calcSomeValue.js', { calcSomeValue: mock.fn() });

    ({ SomeOtherComponent } = await import('./SomeOtherComponent.jsx'));
  });

  describe('when calcSomeValue fails', () => {
    // ã“ã‚Œã¯ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã§å‡¦ç†ã—ãŸããªã„ã§ã—ã‚‡ã†ã€‚ãªãœãªã‚‰ã€ãã‚Œã¯è„†ã„ã‹ã‚‰ã§ã™ã€‚
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«é‡è¦ã§ãªã„æ›´æ–°ãŒè¡Œã‚ã‚ŒãŸå ´åˆã€
    // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¯èª¤ã£ã¦å¤±æ•—ã—ã¾ã™
    // ï¼ˆãã—ã¦ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¯å®Ÿéš›ã«ã¯ä¾¡å€¤ãŒãªã„ã®ã«æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

    it('should fail gracefully by displaying a pretty error', () => {
      calcSomeValue.mockImplementation(function mock__calcSomeValue() { return null });

      render(<SomeOtherComponent>);

      const errorMessage = screen.queryByText('unable');

      assert.ok(errorMessage);
    });
  });
});
```
