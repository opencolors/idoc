import{__plugin_vue_export_helper_default as e,createElementBlock as t,createStaticVNode as n,openBlock as r}from"./chunks/plugin-vue_export-helper.Bts1mPc7.js";const i=JSON.parse(`{"title":"Comprendere la pressione di retroceso nei flussi Node.js","description":"Imparare a implementare flussi Readable e Writable personalizzati in Node.js mentre si rispetta la pressione di retrocesso per garantire un flusso di dati efficiente ed evitare trappole comuni.","frontmatter":{"title":"Comprendere la pressione di retroceso nei flussi Node.js","description":"Imparare a implementare flussi Readable e Writable personalizzati in Node.js mentre si rispetta la pressione di retrocesso per garantire un flusso di dati efficiente ed evitare trappole comuni.","head":[["meta",{"name":"og:title","content":"Comprendere la pressione di retroceso nei flussi Node.js | Node.js - iDoc.dev"}],["meta",{"name":"og:description","content":"Imparare a implementare flussi Readable e Writable personalizzati in Node.js mentre si rispetta la pressione di retrocesso per garantire un flusso di dati efficiente ed evitare trappole comuni."}],["meta",{"name":"twitter:title","content":"Comprendere la pressione di retroceso nei flussi Node.js | Node.js - iDoc.dev"}],["meta",{"name":"twitter:description","content":"Imparare a implementare flussi Readable e Writable personalizzati in Node.js mentre si rispetta la pressione di retrocesso per garantire un flusso di dati efficiente ed evitare trappole comuni."}],["link",{"rel":"canonical","href":"https://idoc.dev/it/nodejs/guide/backpressuring-in-streams"}],["meta",{"property":"og:url","content":"https://idoc.dev/it/nodejs/guide/backpressuring-in-streams"}]]},"headers":[],"relativePath":"it/nodejs/guide/backpressuring-in-streams.md","filePath":"it/nodejs/guide/backpressuring-in-streams.md","lastUpdated":1749464498000}`),a={name:`it/nodejs/guide/backpressuring-in-streams.md`};function o(e,i,a,o,s,c){return r(),t(`div`,null,i[0]||=[n(`<h1 id="backpressure-negli-stream" tabindex="-1">Backpressure negli Stream <a class="header-anchor" href="#backpressure-negli-stream" aria-label="Permalink to “Backpressure negli Stream”">​</a></h1><p>Si verifica un problema generale durante la gestione dei dati chiamato backpressure e descrive un accumulo di dati dietro un buffer durante il trasferimento dei dati. Quando l&#39;estremità ricevente del trasferimento ha operazioni complesse o è più lenta per qualsiasi motivo, c&#39;è una tendenza all&#39;accumulo di dati dalla sorgente in entrata, come un intasamento.</p><p>Per risolvere questo problema, deve essere presente un sistema di delega per garantire un flusso regolare di dati da una sorgente all&#39;altra. Diverse community hanno risolto questo problema in modo univoco per i loro programmi, le pipe Unix e i socket TCP sono buoni esempi di questo e sono spesso indicati come controllo del flusso. In Node.js, gli stream sono stati la soluzione adottata.</p><p>Lo scopo di questa guida è di descrivere ulteriormente cos&#39;è il backpressure e come esattamente gli stream lo affrontano nel codice sorgente di Node.js. La seconda parte della guida introdurrà le migliori pratiche suggerite per garantire che il codice della tua applicazione sia sicuro e ottimizzato quando implementi gli stream.</p><p>Si presume una certa familiarità con la definizione generale di <code>backpressure</code>, <code>Buffer</code> e <code>EventEmitters</code> in Node.js, nonché una certa esperienza con <code>Stream</code>. Se non hai letto quei documenti, non è una cattiva idea dare prima un&#39;occhiata alla <a href="/it/nodejs/api/stream">documentazione dell&#39;API</a>, poiché ti aiuterà ad ampliare la tua comprensione durante la lettura di questa guida.</p><h2 id="il-problema-con-la-gestione-dei-dati" tabindex="-1">Il problema con la gestione dei dati <a class="header-anchor" href="#il-problema-con-la-gestione-dei-dati" aria-label="Permalink to “Il problema con la gestione dei dati”">​</a></h2><p>In un sistema informatico, i dati vengono trasferiti da un processo all&#39;altro tramite pipe, socket e segnali. In Node.js, troviamo un meccanismo simile chiamato <code>Stream</code>. Gli stream sono fantastici! Fanno così tanto per Node.js e quasi ogni parte del codebase interno utilizza quel modulo. Come sviluppatore, sei più che incoraggiato a usarli anche tu!</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> readline</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:readline&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> readline.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createInterface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    output: process.stdout,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    input: process.stdin,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rl.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">question</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Perché dovresti usare gli stream? &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">answer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Forse è \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">answer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}, forse è perché sono fantastici!\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rl.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Un buon esempio del motivo per cui il meccanismo di backpressure implementato attraverso gli stream è un&#39;ottima ottimizzazione può essere dimostrato confrontando gli strumenti di sistema interni dell&#39;implementazione Stream di Node.js.</p><p>In uno scenario, prenderemo un file di grandi dimensioni (circa -9 GB) e lo comprimeremo utilizzando il familiare strumento <code>zip(1)</code>.</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">zip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> The.Matrix.1080p.mkv</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Mentre ci vorranno alcuni minuti per completare, in un&#39;altra shell possiamo eseguire uno script che prende il modulo <code>zlib</code> di Node.js, che racchiude un altro strumento di compressione, <code>gzip(1)</code>.</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> gzip</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:zlib&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createGzip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> inp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;The.Matrix.1080p.mkv&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> out</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;The.Matrix.1080p.mkv.gz&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">inp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(gzip).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(out);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Per testare i risultati, prova ad aprire ogni file compresso. Il file compresso dallo strumento <code>zip(1)</code> ti avviserà che il file è danneggiato, mentre la compressione terminata da Stream si decomprimerà senza errori.</p><div class="tip custom-block"><p class="custom-block-title">Nota</p><p>In questo esempio, usiamo <code>.pipe()</code> per ottenere la sorgente dati da un&#39;estremità all&#39;altra. Tuttavia, nota che non ci sono gestori di errori appropriati collegati. Se un blocco di dati non viene ricevuto correttamente, la sorgente Readable o lo stream <code>gzip</code> non verranno distrutti. <code>pump</code> è uno strumento di utilità che distruggerebbe correttamente tutti gli stream in una pipeline se uno di essi fallisce o si chiude, ed è un must in questo caso!</p></div><p><code>pump</code> è necessario solo per Node.js 8.x o versioni precedenti, poiché per Node.js 10.x o versioni successive, <code>pipeline</code> è stato introdotto per sostituire <code>pump</code>. Questo è un metodo del modulo per connettere stream trasferendo gli errori e pulendo correttamente e fornendo un callback quando la pipeline è completa.</p><p>Ecco un esempio di utilizzo della pipeline:</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pipeline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:stream&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zlib</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:zlib&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Usa l&#39;API pipeline per connettere facilmente una serie di stream</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// insieme e ricevere una notifica quando la pipeline è completamente terminata.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Una pipeline per comprimere in gzip un file video potenzialmente enorme in modo efficiente:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;The.Matrix.1080p.mkv&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  zlib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createGzip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;The.Matrix.1080p.mkv.gz&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  err</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Pipeline failed&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Pipeline succeeded&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Puoi anche utilizzare il modulo <code>stream/promises</code> per utilizzare la pipeline con <code>async / await</code>:</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pipeline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:stream/promises&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zlib</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:zlib&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pipeline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;The.Matrix.1080p.mkv&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      zlib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createGzip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;The.Matrix.1080p.mkv.gz&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Pipeline succeeded&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Pipeline failed&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="troppi-dati-troppo-velocemente" tabindex="-1">Troppi dati, troppo velocemente <a class="header-anchor" href="#troppi-dati-troppo-velocemente" aria-label="Permalink to “Troppi dati, troppo velocemente”">​</a></h2><p>Ci sono casi in cui uno stream <code>Readable</code> potrebbe fornire dati allo stream <code>Writable</code> troppo velocemente - molto più di quanto il consumer possa gestire!</p><p>Quando ciò accade, il consumer inizierà a mettere in coda tutti i chunk di dati per un consumo successivo. La coda di scrittura diventerà sempre più lunga e, a causa di ciò, più dati dovranno essere conservati in memoria fino al completamento dell&#39;intero processo.</p><p>Scrivere su un disco è molto più lento che leggere da un disco, quindi, quando cerchiamo di comprimere un file e scriverlo sul nostro hard disk, si verificherà una contropressione perché il disco di scrittura non sarà in grado di tenere il passo con la velocità di lettura.</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Segretamente lo stream sta dicendo: &quot;ehi, ehi! aspetta, è troppo!&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// I dati inizieranno ad accumularsi sul lato di lettura del buffer di dati mentre</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// write cerca di tenere il passo con il flusso di dati in entrata.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">inp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(gzip).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(outputFile);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Questo è il motivo per cui un meccanismo di contropressione è importante. Se non fosse presente un sistema di contropressione, il processo consumerebbe la memoria del sistema, rallentando efficacemente gli altri processi e monopolizzando gran parte del sistema fino al completamento.</p><p>Ciò si traduce in alcune cose:</p><ul><li>Rallentamento di tutti gli altri processi in corso</li><li>Un garbage collector molto sovraccarico di lavoro</li><li>Esaurimento della memoria</li></ul><p>Nei seguenti esempi, prenderemo il valore di ritorno della funzione <code>.write()</code> e lo cambieremo in <code>true</code>, il che disabilita efficacemente il supporto alla contropressione nel core di Node.js. In qualsiasi riferimento al binario <code>&#39;modified&#39;</code>, stiamo parlando dell&#39;esecuzione del binario node senza la riga <code>return ret;</code>, e invece con la riga sostituita <code>return true;</code>.</p><h2 id="eccessivo-trascinamento-sulla-garbage-collection" tabindex="-1">Eccessivo trascinamento sulla garbage collection <a class="header-anchor" href="#eccessivo-trascinamento-sulla-garbage-collection" aria-label="Permalink to “Eccessivo trascinamento sulla garbage collection”">​</a></h2><p>Diamo un&#39;occhiata a un rapido benchmark. Usando lo stesso esempio di sopra, abbiamo eseguito alcune prove a tempo per ottenere un tempo medio per entrambi i binari.</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   trial</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (#)  | \`node\` binary (ms) | modified \`node\` binary (ms)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=================================================================</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      56924</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">           55011</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      52686</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">           55869</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      59479</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">           54043</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      54473</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">           55229</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      52933</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">           59723</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=================================================================</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">average</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      55299</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">           55975</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Entrambi impiegano circa un minuto per essere eseguiti, quindi non c&#39;è molta differenza, ma diamo un&#39;occhiata più da vicino per confermare se i nostri sospetti sono corretti. Usiamo lo strumento Linux <code>dtrace</code> per valutare cosa sta succedendo con il garbage collector V8.</p><p>Il tempo misurato dalla GC (garbage collector) indica gli intervalli di un ciclo completo di una singola scansione eseguita dal garbage collector:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">approx.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ms) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ms) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> modified</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ms)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=================================================</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         40</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        170</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        300</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">           *</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">           *</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">           *</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      39000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    6</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     26</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      42000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    6</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     21</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      47000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     32</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      50000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    8</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      54000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    6</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     35</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>Mentre i due processi iniziano allo stesso modo e sembrano far lavorare la GC alla stessa velocità, diventa evidente che dopo alcuni secondi con un sistema di contropressione funzionante, distribuisce il carico della GC su intervalli coerenti di 4-8 millisecondi fino alla fine del trasferimento dei dati.</p><p>Tuttavia, quando un sistema di contropressione non è in atto, la garbage collection V8 inizia a trascinarsi. Il binario normale chiama la GC circa 75 volte in un minuto, mentre il binario modificato la chiama solo 36 volte.</p><p>Questo è il debito lento e graduale che si accumula dall&#39;aumento dell&#39;utilizzo della memoria. Man mano che i dati vengono trasferiti, senza un sistema di contropressione in atto, viene utilizzata più memoria per ogni trasferimento di chunk.</p><p>Più memoria viene allocata, più la GC deve prendersi cura in una sola scansione. Più grande è la scansione, più la GC deve decidere cosa può essere liberato e la scansione di puntatori scollegati in uno spazio di memoria più ampio consumerà più potenza di calcolo.</p><h2 id="esaurimento-della-memoria" tabindex="-1">Esaurimento della Memoria <a class="header-anchor" href="#esaurimento-della-memoria" aria-label="Permalink to “Esaurimento della Memoria”">​</a></h2><p>Per determinare il consumo di memoria di ciascun binario, abbiamo monitorato ogni processo con <code>/usr/bin/time -lp sudo ./node ./backpressure-example/zlib.js</code> individualmente.</p><p>Questo è l&#39;output sul binario normale:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Rispetto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> del</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> valore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ritorno</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=============================================</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">real</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        58.88</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        56.79</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sys</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          8.79</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  87810048</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  dimensione</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> massima</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> del</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> residente</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  dimensione</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> media</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> della</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memoria</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> condivisa</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  dimensione</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> media</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dei</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dati</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> non</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> condivisi</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  dimensione</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> media</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dello</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stack</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> non</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> condiviso</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     19427</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  recuperi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pagina</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      3134</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  errori</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pagina</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  swap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  operazioni</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> input</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> blocchi</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       194</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  operazioni</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> output</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> blocchi</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  messaggi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> inviati</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  messaggi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ricevuti</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  segnali</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ricevuti</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        12</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  cambi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> contesto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> volontari</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    666037</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  cambi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> contesto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> involontari</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>La dimensione massima in byte occupata dalla memoria virtuale risulta essere approssimativamente 87.81 mb.</p><p>E ora, cambiando il valore di ritorno della funzione <code>.write()</code>, otteniamo:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Senza</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rispettare</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> il</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> valore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ritorno</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">==================================================</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">real</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        54.48</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        53.15</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sys</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          7.43</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1524965376</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  dimensione</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> massima</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> del</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> residente</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  dimensione</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> media</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> della</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memoria</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> condivisa</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  dimensione</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> media</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dei</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dati</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> non</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> condivisi</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  dimensione</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> media</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dello</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stack</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> non</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> condiviso</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    373617</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  recuperi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pagina</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      3139</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  errori</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pagina</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  swap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        18</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  operazioni</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> input</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> blocchi</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       199</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  operazioni</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> output</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> blocchi</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  messaggi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> inviati</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  messaggi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ricevuti</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  segnali</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ricevuti</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        25</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  cambi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> contesto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> volontari</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    629566</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  cambi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> contesto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> involontari</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>La dimensione massima in byte occupata dalla memoria virtuale risulta essere approssimativamente 1.52 gb.</p><p>Senza stream in atto per delegare la contropressione, c&#39;è un ordine di grandezza maggiore di spazio di memoria allocato - un enorme margine di differenza tra lo stesso processo!</p><p>Questo esperimento mostra quanto sia ottimizzato ed economico il meccanismo di contropressione di Node.js per il tuo sistema di calcolo. Ora, analizziamo come funziona!</p><h2 id="in-che-modo-la-contropressione-risolve-questi-problemi" tabindex="-1">In che modo la contropressione risolve questi problemi? <a class="header-anchor" href="#in-che-modo-la-contropressione-risolve-questi-problemi" aria-label="Permalink to “In che modo la contropressione risolve questi problemi?”">​</a></h2><p>Esistono diverse funzioni per trasferire dati da un processo all&#39;altro. In Node.js, esiste una funzione integrata interna chiamata <code>.pipe()</code>. Ci sono anche altri pacchetti che puoi usare! In definitiva, però, al livello base di questo processo, abbiamo due componenti separati: la sorgente dei dati e il consumatore.</p><p>Quando <code>.pipe()</code> viene chiamato dalla sorgente, segnala al consumatore che ci sono dati da trasferire. La funzione pipe aiuta a impostare le chiusure di contropressione appropriate per gli attivatori di eventi.</p><p>In Node.js la sorgente è uno stream <code>Readable</code> e il consumatore è uno stream <code>Writable</code> (entrambi questi possono essere scambiati con uno stream Duplex o Transform, ma ciò è fuori ambito per questa guida).</p><p>Il momento in cui la contropressione viene attivata può essere ristretto esattamente al valore di ritorno di una funzione <code>.write()</code> di <code>Writable</code>. Questo valore di ritorno è determinato da alcune condizioni, ovviamente.</p><p>In qualsiasi scenario in cui il buffer di dati ha superato il <code>highwaterMark</code> o la coda di scrittura è attualmente occupata, <code>.write()</code> <code>restituirà false</code>.</p><p>Quando viene restituito un valore <code>false</code>, si attiva il sistema di contropressione. Metterà in pausa lo stream <code>Readable</code> in entrata dall&#39;invio di dati e attenderà fino a quando il consumatore non sarà di nuovo pronto. Una volta svuotato il buffer di dati, verrà emesso un evento <code>&#39;drain&#39;</code> e riprenderà il flusso di dati in entrata.</p><p>Una volta terminata la coda, la contropressione consentirà di inviare nuovamente i dati. Lo spazio in memoria che veniva utilizzato si libererà e si preparerà per il prossimo batch di dati.</p><p>Ciò consente effettivamente di utilizzare una quantità fissa di memoria in un dato momento per una funzione <code>.pipe()</code>. Non ci saranno perdite di memoria, né buffering infinito e il garbage collector dovrà occuparsi solo di un&#39;area di memoria!</p><p>Quindi, se la contropressione è così importante, perché (probabilmente) non ne hai mai sentito parlare? Bene, la risposta è semplice: Node.js fa tutto questo automaticamente per te.</p><p>È fantastico! Ma anche non così eccezionale quando cerchiamo di capire come implementare i nostri stream personalizzati.</p><div class="info custom-block"><p class="custom-block-title">NOTA</p><p>Nella maggior parte delle macchine, esiste una dimensione in byte che determina quando un buffer è pieno (che varierà a seconda delle diverse macchine). Node.js ti consente di impostare il tuo <code>highWaterMark</code> personalizzato, ma comunemente, il valore predefinito è impostato su 16 kb (16384 o 16 per gli stream objectMode). Nei casi in cui potresti voler aumentare tale valore, fallo pure, ma con cautela!</p></div><h2 id="ciclo-di-vita-di-pipe" tabindex="-1">Ciclo di vita di <code>.pipe()</code> <a class="header-anchor" href="#ciclo-di-vita-di-pipe" aria-label="Permalink to “Ciclo di vita di .pipe()”">​</a></h2><p>Per ottenere una migliore comprensione della contropressione, ecco un diagramma di flusso sul ciclo di vita di uno stream <code>Readable</code> che viene <a href="/it/nodejs/api/stream">indirizzato</a> in uno stream <code>Writable</code>:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                                     +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">===================+</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                         x--</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Funzioni</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> piping</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   src.pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                         x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     vengono</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> impostate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">===================</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                         x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     durante</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> il</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metodo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Callback</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> degli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eventi</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">===============+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     .pipe.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-------------------</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   I</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tuoi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dati</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                           |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> .on(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;close&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=======+=======+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Esistono</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> al</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fuori</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> .on(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;data&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">              x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     del</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> flusso</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> di</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dati,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> .on(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;drain&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">              x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     ma</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> è</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> importante</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> .on(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;unpipe&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+---------v---------+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     allegare</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eventi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> .on(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;error&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Stream</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Readable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  +----+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     le</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> loro</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rispettive</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> .on(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;finish&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+-^-------^-------^-+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     callback.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> .on(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&#39;end&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                           +-------------------+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       ^</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    +-------------------+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         +=================+</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       ^</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      +---</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Stream</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Writable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  +--------</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  .write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">           +-------------------+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         +=======+=========+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                                                 |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                              +------------------v---------+</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       +-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (!chunk)                </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Questo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chunk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> è</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> troppo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     emit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();             </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   grande?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> La</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> coda</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> è</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       +-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   occupata?</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     emit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();                   </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+-------+----------------+---+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       ^</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       ^</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                   +--v---+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        +---v---+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                                           &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  No</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Sì</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                           +------+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        +---v---+</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                                                               |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       ^</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">               emit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .pause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();          </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=================+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       ^---------------^-----------------------+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-----+---+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                               +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=================+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                                                                           |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            quando</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> la</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> coda</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> è</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vuota</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +============+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                         |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^------------^-----------------------</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Buffering</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                         |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">               |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                       |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">============</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                         |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">               +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">emit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .drain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();       </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^Buffer^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                         |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">               +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">emit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .resume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();      </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+------------+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                         |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                                       |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ^Buffer^</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                         |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                       +------------+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   aggiungi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chunk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> alla</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> coda</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                       +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">============+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">---^---------------------</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">NOTA</p><p>Se stai impostando una pipeline per concatenare alcuni stream per manipolare i tuoi dati, molto probabilmente implementerai lo stream Transform.</p></div><p>In questo caso, l&#39;output dallo stream <code>Readable</code> entrerà nel <code>Transform</code> e verrà indirizzato al <code>Writable</code>.</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Readable.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Transformable).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Writable);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>La contropressione verrà applicata automaticamente, ma tieni presente che sia l&#39;<code>highwaterMark</code> in entrata che in uscita dello stream <code>Transform</code> possono essere manipolati e influenzeranno il sistema di contropressione.</p><h2 id="linee-guida-sulla-contropressione" tabindex="-1">Linee Guida sulla Contropressione <a class="header-anchor" href="#linee-guida-sulla-contropressione" aria-label="Permalink to “Linee Guida sulla Contropressione”">​</a></h2><p>Dalla versione v0.10 di Node.js, la classe Stream offre la possibilità di modificare il comportamento di <code>.read()</code> o <code>.write()</code> utilizzando la versione con underscore di queste rispettive funzioni (<code>._read()</code> e <code>._write()</code>).</p><p>Sono documentate le linee guida per l&#39;implementazione di stream Readable e per l&#39;implementazione di stream Writable. Supporremo che tu le abbia lette, e la prossima sezione entrerà un po&#39; più nel dettaglio.</p><h2 id="regole-da-rispettare-quando-si-implementano-stream-personalizzati" tabindex="-1">Regole da Rispettare Quando si Implementano Stream Personalizzati <a class="header-anchor" href="#regole-da-rispettare-quando-si-implementano-stream-personalizzati" aria-label="Permalink to “Regole da Rispettare Quando si Implementano Stream Personalizzati”">​</a></h2><p>La regola d&#39;oro degli stream è rispettare sempre la contropressione. Ciò che costituisce la migliore pratica è una pratica non contraddittoria. Finché sei attento a evitare comportamenti che confliggono con il supporto interno della contropressione, puoi essere sicuro di seguire una buona pratica.</p><p>In generale,</p><ol><li>Non usare mai <code>.push()</code> se non ti viene chiesto.</li><li>Non chiamare mai <code>.write()</code> dopo che restituisce false ma aspetta invece &#39;drain&#39;.</li><li>Gli stream cambiano tra diverse versioni di Node.js e la libreria che usi. Fai attenzione e testa le cose.</li></ol><div class="tip custom-block"><p class="custom-block-title">NOTE</p><p>Per quanto riguarda il punto 3, un pacchetto incredibilmente utile per la creazione di stream per browser è <code>readable-stream</code>. Rodd Vagg ha scritto un <a href="https://r.va.gg/2014/06/why-i-dont-use-nodes-core-stream-module.html" target="_blank" rel="noreferrer">ottimo post sul blog</a> che descrive l&#39;utilità di questa libreria. In breve, fornisce un tipo di degradazione graduale automatizzata per gli stream Readable e supporta le versioni precedenti di browser e Node.js.</p></div><h2 id="regole-specifiche-per-gli-stream-readable" tabindex="-1">Regole specifiche per gli Stream Readable <a class="header-anchor" href="#regole-specifiche-per-gli-stream-readable" aria-label="Permalink to “Regole specifiche per gli Stream Readable”">​</a></h2><p>Finora, abbiamo dato un&#39;occhiata a come <code>.write()</code> influisce sulla contropressione e ci siamo concentrati molto sullo stream Writable. A causa della funzionalità di Node.js, i dati tecnicamente fluiscono a valle da Readable a Writable. Tuttavia, come possiamo osservare in qualsiasi trasmissione di dati, materia o energia, la sorgente è altrettanto importante della destinazione e lo stream Readable è vitale per come viene gestita la contropressione.</p><p>Entrambi questi processi si basano l&#39;uno sull&#39;altro per comunicare efficacemente, se il Readable ignora quando lo stream Writable gli chiede di smettere di inviare dati, può essere problematico tanto quanto quando il valore di ritorno di <code>.write()</code> è errato.</p><p>Quindi, oltre a rispettare il ritorno di <code>.write()</code>, dobbiamo anche rispettare il valore di ritorno di <code>.push()</code> usato nel metodo <code>._read()</code>. Se <code>.push()</code> restituisce un valore false, lo stream smetterà di leggere dalla sorgente. Altrimenti, continuerà senza pausa.</p><p>Ecco un esempio di cattiva pratica usando <code>.push()</code>:</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Questo è problematico in quanto ignora completamente il valore di ritorno dal push</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// che potrebbe essere un segnale di contropressione dallo stream di destinazione!</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyReadable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Readable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  _read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunk;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (chunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getNextChunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Inoltre, dall&#39;esterno dello stream personalizzato, ci sono insidie nell&#39;ignorare la contropressione. In questo controesempio di buona pratica, il codice dell&#39;applicazione forza i dati attraverso ogni volta che sono disponibili (segnalato dall&#39;evento <code>&#39;data&#39;</code>):</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Questo ignora i meccanismi di contropressione che Node.js ha messo in atto,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// e spinge incondizionatamente i dati, indipendentemente dal fatto che lo</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// stream di destinazione sia pronto o meno.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readable.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> writable.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Ecco un esempio di utilizzo di <code>.push()</code> con uno stream Readable.</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Readable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:stream&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Crea uno stream Readable personalizzato</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> myReadableStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Readable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  objectMode: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Inserisci alcuni dati nello stream</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Hello, world!&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Contrassegna la fine dello stream</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Consuma lo stream</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">myReadableStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">chunk</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Output:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// { message: &#39;Hello, world!&#39; }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="regole-specifiche-per-i-flussi-scrivibili" tabindex="-1">Regole specifiche per i flussi scrivibili <a class="header-anchor" href="#regole-specifiche-per-i-flussi-scrivibili" aria-label="Permalink to “Regole specifiche per i flussi scrivibili”">​</a></h2><p>Ricorda che <code>.write()</code> può restituire true o false a seconda di alcune condizioni. Fortunatamente per noi, quando creiamo il nostro flusso scrivibile, la macchina a stati del flusso gestirà i nostri callback e determinerà quando gestire la contropressione e ottimizzare il flusso di dati per noi. Tuttavia, quando vogliamo usare direttamente un Writable, dobbiamo rispettare il valore di ritorno di <code>.write()</code> e prestare molta attenzione a queste condizioni:</p><ul><li>Se la coda di scrittura è occupata, <code>.write()</code> restituirà false.</li><li>Se il chunk di dati è troppo grande, <code>.write()</code> restituirà false (il limite è indicato dalla variabile highWaterMark).</li></ul><p>In questo esempio, creiamo un flusso Readable personalizzato che inserisce un singolo oggetto nel flusso usando <code>.push()</code>. Il metodo <code>._read()</code> viene chiamato quando il flusso è pronto a consumare dati e, in questo caso, inseriamo immediatamente alcuni dati nel flusso e contrassegniamo la fine del flusso inserendo <code>null</code>.</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;stream&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyReadable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Readable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    super</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  _read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Ciao, mondo!&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> readableStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyReadable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readableStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(process.stdout);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Quindi consumiamo il flusso ascoltando l&#39;evento &#39;data&#39; e registrando ogni chunk di dati che viene inserito nel flusso. In questo caso, inseriamo solo un singolo chunk di dati nel flusso, quindi vediamo solo un messaggio di log.</p><h2 id="regole-specifiche-per-i-flussi-scrivibili-1" tabindex="-1">Regole specifiche per i flussi scrivibili <a class="header-anchor" href="#regole-specifiche-per-i-flussi-scrivibili-1" aria-label="Permalink to “Regole specifiche per i flussi scrivibili”">​</a></h2><p>Ricorda che <code>.write()</code> può restituire true o false a seconda di alcune condizioni. Fortunatamente per noi, quando creiamo il nostro flusso scrivibile, la macchina a stati del flusso gestirà i nostri callback e determinerà quando gestire la contropressione e ottimizzare il flusso di dati per noi.</p><p>Tuttavia, quando vogliamo usare direttamente un Writable, dobbiamo rispettare il valore di ritorno di <code>.write()</code> e prestare molta attenzione a queste condizioni:</p><ul><li>Se la coda di scrittura è occupata, <code>.write()</code> restituirà false.</li><li>Se il chunk di dati è troppo grande, <code>.write()</code> restituirà false (il limite è indicato dalla variabile highWaterMark).</li></ul><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyWritable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Writable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Questo Writable non è valido a causa della natura asincrona dei callback JavaScript.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Senza un&#39;istruzione return per ogni callback prima dell&#39;ultimo,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // c&#39;è un&#39;alta probabilità che vengano chiamati più callback.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">encoding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (chunk.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">indexOf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;a&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (chunk.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">indexOf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;b&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Ci sono anche alcune cose a cui prestare attenzione quando si implementa <code>._writev()</code>. La funzione è accoppiata con <code>.cork()</code>, ma c&#39;è un errore comune durante la scrittura:</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Usare .uncork() due volte qui fa due chiamate al livello C++, rendendo la</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// tecnica cork/uncork inutile.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ciao &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mondo &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uncork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;da &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Matteo&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uncork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Il modo corretto per scrivere questo è utilizzare process.nextTick(), che si attiva</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// al prossimo ciclo di eventi.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ciao &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mondo &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">process.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextTick</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(doUncork, ws);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;da &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Matteo&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">process.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextTick</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(doUncork, ws);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Come funzione globale.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doUncork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  stream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uncork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><code>.cork()</code> può essere chiamato tutte le volte che vogliamo, dobbiamo solo fare attenzione a chiamare <code>.uncork()</code> lo stesso numero di volte per farlo fluire di nuovo.</p><h2 id="conclusione" tabindex="-1">Conclusione <a class="header-anchor" href="#conclusione" aria-label="Permalink to “Conclusione”">​</a></h2><p>Gli stream sono un modulo utilizzato frequentemente in Node.js. Sono importanti per la struttura interna e, per gli sviluppatori, per espandersi e connettersi attraverso l&#39;ecosistema dei moduli Node.js.</p><p>Speriamo che ora tu sia in grado di risolvere i problemi e programmare in modo sicuro i tuoi stream <code>Writable</code> e <code>Readable</code> tenendo presente la contropressione, e di condividere le tue conoscenze con colleghi e amici.</p><p>Assicurati di leggere di più su <code>Stream</code> per altre funzioni API che ti aiuteranno a migliorare e liberare le tue capacità di streaming quando crei un&#39;applicazione con Node.js.</p>`,104)])}var s=e(a,[[`render`,o]]);export{i as __pageData,s as default};