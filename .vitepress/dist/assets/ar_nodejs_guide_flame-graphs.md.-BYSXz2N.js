import{__plugin_vue_export_helper_default as e,createElementBlock as t,createStaticVNode as n,openBlock as r}from"./chunks/plugin-vue_export-helper.Bts1mPc7.js";const i=JSON.parse(`{"title":"رسوم البيانية للشعلات لتحسين أداء Node.js","description":"تعلم كيفية إنشاء رسوم بيانية للشعلات لتصور الوقت الذي يقضيه المعالج في الدوال وتحسين أداء Node.js.","frontmatter":{"title":"رسوم البيانية للشعلات لتحسين أداء Node.js","description":"تعلم كيفية إنشاء رسوم بيانية للشعلات لتصور الوقت الذي يقضيه المعالج في الدوال وتحسين أداء Node.js.","head":[["meta",{"name":"og:title","content":"رسوم البيانية للشعلات لتحسين أداء Node.js | Node.js - iDoc.dev"}],["meta",{"name":"og:description","content":"تعلم كيفية إنشاء رسوم بيانية للشعلات لتصور الوقت الذي يقضيه المعالج في الدوال وتحسين أداء Node.js."}],["meta",{"name":"twitter:title","content":"رسوم البيانية للشعلات لتحسين أداء Node.js | Node.js - iDoc.dev"}],["meta",{"name":"twitter:description","content":"تعلم كيفية إنشاء رسوم بيانية للشعلات لتصور الوقت الذي يقضيه المعالج في الدوال وتحسين أداء Node.js."}],["link",{"rel":"canonical","href":"https://idoc.dev/ar/nodejs/guide/flame-graphs"}],["meta",{"property":"og:url","content":"https://idoc.dev/ar/nodejs/guide/flame-graphs"}]]},"headers":[],"relativePath":"ar/nodejs/guide/flame-graphs.md","filePath":"ar/nodejs/guide/flame-graphs.md","lastUpdated":null}`),a={name:`ar/nodejs/guide/flame-graphs.md`};function o(e,i,a,o,s,c){return r(),t(`div`,null,i[0]||=[n(`<h1 id="مخططات-اللهب" tabindex="-1">مخططات اللهب <a class="header-anchor" href="#مخططات-اللهب" aria-label="Permalink to “مخططات اللهب”">​</a></h1><h2 id="ما-هي-فائدة-مخطط-اللهب؟" tabindex="-1">ما هي فائدة مخطط اللهب؟ <a class="header-anchor" href="#ما-هي-فائدة-مخطط-اللهب؟" aria-label="Permalink to “ما هي فائدة مخطط اللهب؟”">​</a></h2><p>مخططات اللهب هي طريقة لتصور وقت وحدة المعالجة المركزية (CPU) الذي يتم قضاؤه في الدوال. يمكن أن تساعدك في تحديد مكان قضاء الكثير من الوقت في إجراء عمليات متزامنة.</p><h2 id="كيفية-إنشاء-مخطط-لهب" tabindex="-1">كيفية إنشاء مخطط لهب <a class="header-anchor" href="#كيفية-إنشاء-مخطط-لهب" aria-label="Permalink to “كيفية إنشاء مخطط لهب”">​</a></h2><p>ربما سمعت أن إنشاء مخطط لهب لـ Node.js أمر صعب، ولكن هذا غير صحيح (بعد الآن). لم تعد هناك حاجة إلى أجهزة Solaris الظاهرية لمخططات اللهب!</p><p>يتم إنشاء مخططات اللهب من مخرجات <code>perf</code>، وهي ليست أداة خاصة بـ Node. ومع ذلك، فهي الطريقة الأقوى لتصور وقت وحدة المعالجة المركزية (CPU) الذي يتم قضاؤه، وقد تواجه مشكلات في كيفية تحسين كود JavaScript في Node.js 8 والإصدارات الأحدث. راجع قسم <a href="#perf-output-issues">مشكلات مخرجات perf</a> أدناه.</p><h3 id="استخدم-أداة-مُجمَّعة-مسبقًا" tabindex="-1">استخدم أداة مُجمَّعة مسبقًا <a class="header-anchor" href="#استخدم-أداة-مُجمَّعة-مسبقًا" aria-label="Permalink to “استخدم أداة مُجمَّعة مسبقًا”">​</a></h3><p>إذا كنت تريد خطوة واحدة تنتج مخطط لهب محليًا، فجرّب <a href="https://www.npmjs.com/package/0x" target="_blank" rel="noreferrer">0x</a></p><p>لتشخيص عمليات النشر في الإنتاج، اقرأ هذه الملاحظات: <a href="https://github.com/davidmarkclements/0x/blob/master/docs/production-servers.md" target="_blank" rel="noreferrer">0x خوادم الإنتاج</a>.</p><h3 id="إنشاء-مخطط-لهب-باستخدام-أدوات-perf-النظام" tabindex="-1">إنشاء مخطط لهب باستخدام أدوات perf النظام <a class="header-anchor" href="#إنشاء-مخطط-لهب-باستخدام-أدوات-perf-النظام" aria-label="Permalink to “إنشاء مخطط لهب باستخدام أدوات perf النظام”">​</a></h3><p>الغرض من هذا الدليل هو عرض الخطوات المتضمنة في إنشاء مخطط لهب وإبقائك متحكمًا في كل خطوة.</p><p>إذا كنت ترغب في فهم كل خطوة بشكل أفضل، فراجع الأقسام التالية حيث نتعمق في التفاصيل.</p><p>الآن هيا بنا نبدأ العمل.</p><ol><li>قم بتثبيت <code>perf</code> (عادةً ما يكون متاحًا من خلال حزمة linux-tools-common إذا لم يكن مثبتًا بالفعل)</li><li>حاول تشغيل <code>perf</code> - قد يشتكي من وجود وحدات kernel مفقودة، قم بتثبيتها أيضًا</li><li>قم بتشغيل node مع تمكين perf (راجع <a href="#perf-output-issues">مشكلات مخرجات perf</a> للحصول على نصائح خاصة بإصدارات Node.js)</li></ol><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">perf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> record</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cycles:u</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -g</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --perf-basic-prof</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app.js</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="4"><li>تجاهل التحذيرات ما لم تكن تقول أنك لا تستطيع تشغيل perf بسبب الحزم المفقودة؛ قد تحصل على بعض التحذيرات بشأن عدم القدرة على الوصول إلى عينات وحدة kernel التي لا تبحث عنها على أي حال.</li><li>قم بتشغيل <code>perf script &gt; perfs.out</code> لإنشاء ملف البيانات الذي ستصوره في لحظة. من المفيد تطبيق بعض التنظيف للحصول على رسم بياني أكثر قابلية للقراءة</li><li>قم بتثبيت stackvis إذا لم يكن مثبتًا بعد <code>npm i -g stackvis</code></li><li>قم بتشغيل <code>stackvis perf &lt; perfs.out &gt; flamegraph.htm</code></li></ol><p>الآن افتح ملف مخطط اللهب في متصفحك المفضل وشاهده يحترق. إنه مرمّز بالألوان بحيث يمكنك التركيز على الأشرطة البرتقالية الأكثر تشبعًا أولاً. من المحتمل أن تمثل دوالًا ثقيلة بوحدة المعالجة المركزية (CPU).</p><p>تجدر الإشارة إلى أنه - إذا نقرت فوق عنصر في مخطط اللهب، فسيتم عرض تكبير لمحيطه أعلى الرسم البياني.</p><h3 id="استخدام-perf-لأخذ-عينات-من-عملية-قيد-التشغيل" tabindex="-1">استخدام <code>perf</code> لأخذ عينات من عملية قيد التشغيل <a class="header-anchor" href="#استخدام-perf-لأخذ-عينات-من-عملية-قيد-التشغيل" aria-label="Permalink to “استخدام perf لأخذ عينات من عملية قيد التشغيل”">​</a></h3><p>هذا رائع لتسجيل بيانات الرسم البياني الناري من عملية قيد التشغيل بالفعل ولا تريد مقاطعتها. تخيل عملية إنتاج بها مشكلة يصعب إعادة إنتاجها.</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">perf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> record</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -F99</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pgrep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node\`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>ما فائدة <code>sleep 3</code>؟ إنها موجودة للحفاظ على تشغيل perf - على الرغم من أن الخيار <code>-p</code> يشير إلى معرف عملية مختلف، إلا أنه يجب تنفيذ الأمر على عملية وينتهي به. يعمل perf طوال مدة الأمر الذي تمرره إليه، سواء كنت تقوم بالفعل بتوصيف هذا الأمر أم لا. يضمن <code>sleep 3</code> أن يعمل perf لمدة 3 ثوانٍ.</p><p>لماذا تم تعيين <code>-F</code> (تردد التوصيف) على 99؟ إنه إعداد افتراضي معقول. يمكنك تعديله إذا كنت تريد ذلك. <code>-F99</code> يخبر perf بأخذ 99 عينة في الثانية، لزيادة الدقة قم بزيادة القيمة. يجب أن تنتج القيم المنخفضة مخرجات أقل بنتائج أقل دقة. تعتمد الدقة التي تحتاجها على المدة التي تعمل فيها وظائفك المكثفة لوحدة المعالجة المركزية بالفعل. إذا كنت تبحث عن سبب لتباطؤ ملحوظ، فيجب أن تكون 99 إطارًا في الثانية أكثر من كافية.</p><p>بعد الحصول على سجل perf لمدة 3 ثوانٍ، تابع إنشاء الرسم البياني الناري بالخطوتين الأخيرتين من الأعلى.</p><h3 id="تصفية-وظائف-node-js-الداخلية" tabindex="-1">تصفية وظائف Node.js الداخلية <a class="header-anchor" href="#تصفية-وظائف-node-js-الداخلية" aria-label="Permalink to “تصفية وظائف Node.js الداخلية”">​</a></h3><p>عادةً، تريد فقط إلقاء نظرة على أداء مكالماتك، لذلك يمكن أن تجعل تصفية وظائف Node.js و V8 الداخلية الرسم البياني أسهل بكثير في القراءة. يمكنك تنظيف ملف perf الخاص بك باستخدام:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/(_libc_start|LazyCompile) |v8::internal::BuiltIn|Stub|LoadIC:\\\\[\\\\[&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/^$/d&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    perf.data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> perf.out</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>إذا قرأت الرسم البياني الناري الخاص بك وبدا غريبًا، كما لو كان هناك شيء مفقود في الوظيفة الرئيسية التي تستغرق معظم الوقت، فحاول إنشاء الرسم البياني الناري الخاص بك بدون عوامل التصفية - ربما تكون قد حصلت على حالة نادرة لمشكلة في Node.js نفسه.</p><h3 id="خيارات-التوصيف-الخاصة-بـ-node-js" tabindex="-1">خيارات التوصيف الخاصة بـ Node.js <a class="header-anchor" href="#خيارات-التوصيف-الخاصة-بـ-node-js" aria-label="Permalink to “خيارات التوصيف الخاصة بـ Node.js”">​</a></h3><p><code>--perf-basic-prof-only-functions</code> و <code>--perf-basic-prof</code> هما الخياران المفيدان لتصحيح أخطاء كود JavaScript الخاص بك. تُستخدم الخيارات الأخرى لتوصيف Node.js نفسه، وهو خارج نطاق هذا الدليل.</p><p>تنتج <code>--perf-basic-prof-only-functions</code> مخرجات أقل، لذلك فهو الخيار الذي لديه أقل حمل.</p><h3 id="لماذا-أحتاج-إليها-على-الإطلاق؟" tabindex="-1">لماذا أحتاج إليها على الإطلاق؟ <a class="header-anchor" href="#لماذا-أحتاج-إليها-على-الإطلاق؟" aria-label="Permalink to “لماذا أحتاج إليها على الإطلاق؟”">​</a></h3><p>حسنًا، بدون هذه الخيارات، ستحصل على رسم بياني لهب، ولكن مع معظم الأشرطة التي تحمل اسم <code>v8::Function::Call</code>.</p><h2 id="مشكلات-إخراج-perf" tabindex="-1">مشكلات إخراج <code>Perf</code> <a class="header-anchor" href="#مشكلات-إخراج-perf" aria-label="Permalink to “مشكلات إخراج Perf”">​</a></h2><h3 id="تغييرات-مسار-v8-في-node-js-8-x" tabindex="-1">تغييرات مسار V8 في Node.js 8.x <a class="header-anchor" href="#تغييرات-مسار-v8-في-node-js-8-x" aria-label="Permalink to “تغييرات مسار V8 في Node.js 8.x”">​</a></h3><p>تأتي Node.js 8.x والإصدارات الأحدث مع تحسينات جديدة لمسار تجميع JavaScript في محرك V8 مما يجعل أسماء/مراجع الدوال غير قابلة للوصول إلى perf في بعض الأحيان. (يُطلق عليه Turbofan)</p><p>والنتيجة هي أنك قد لا تحصل على أسماء الدوال الخاصة بك بشكل صحيح في الرسم البياني للهب.</p><p>ستلاحظ <code>ByteCodeHandler:</code> حيث تتوقع أسماء الدوال.</p><p>يحتوي 0x على بعض التخفيفات المضمنة لذلك.</p><p>للحصول على التفاصيل، راجع:</p><ul><li><a href="https://github.com/nodejs/benchmarking/issues/168" target="_blank" rel="noreferrer">https://github.com/nodejs/benchmarking/issues/168</a></li><li><a href="https://github.com/nodejs/diagnostics/issues/148#issuecomment-369348961" target="_blank" rel="noreferrer">https://github.com/nodejs/diagnostics/issues/148#issuecomment-369348961</a></li></ul><h3 id="node-js-10" tabindex="-1">Node.js 10+ <a class="header-anchor" href="#node-js-10" aria-label="Permalink to “Node.js 10+”">​</a></h3><p>تعالج Node.js 10.x المشكلة المتعلقة بـ Turbofan باستخدام العلامة <code>--interpreted-frames-native-stack</code>.</p><p>قم بتشغيل <code>node --interpreted-frames-native-stack --perf-basic-prof-only-functions</code> للحصول على أسماء الدوال في الرسم البياني للهب بغض النظر عن مسار V8 الذي استخدمه لتجميع JavaScript الخاص بك.</p><h3 id="تسميات-تالفة-في-الرسم-البياني-للهب" tabindex="-1">تسميات تالفة في الرسم البياني للهب <a class="header-anchor" href="#تسميات-تالفة-في-الرسم-البياني-للهب" aria-label="Permalink to “تسميات تالفة في الرسم البياني للهب”">​</a></h3><p>إذا كنت ترى تسميات تبدو هكذا</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_ZN2v88internal11interpreter17BytecodeGenerator15VisitStatementsEPMS0_8Zone</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>فهذا يعني أن Linux perf الذي تستخدمه لم يتم تجميعه مع دعم demangle، راجع <a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1396654" target="_blank" rel="noreferrer">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1396654</a> على سبيل المثال</p><h2 id="أمثلة" tabindex="-1">أمثلة <a class="header-anchor" href="#أمثلة" aria-label="Permalink to “أمثلة”">​</a></h2><p>تدرب على التقاط الرسوم البيانية للهب بنفسك من خلال <a href="https://github.com/naugtur/node-example-flamegraph" target="_blank" rel="noreferrer">تمرين الرسم البياني للهب</a>!</p>`,50)])}var s=e(a,[[`render`,o]]);export{i as __pageData,s as default};